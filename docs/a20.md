# A20とは

8086 CPU は、A0〜A19 の 20 本のアドレスバスしか持たず、指定できるアドレス空間は 2^20 バイト、つまり 1MB に制限されていた。

このため、1MB を超えるアドレスを指定すると、物理的に上位ビットが存在しないためアドレスが折り返し、次のように 0 番地に戻ってしまう。
```
0x000FFFFF + 1 → 0x00000000
```
後継の CPU（80286 以降）ではアドレスバスが拡張され、1MB を超えるメモリ空間を扱えるようになった。
しかし、8086 のこの「1MB で折り返す」挙動を前提として書かれたプログラムもあり、
後継 CPU では互換性を保つためにA20ラインを意図的に無効化できる仕組みが追加された。
これが A20ゲートである。

A20 ゲートが無効な状態では、後継 CPUであっても 8086 と同様に1MBでアドレスが折り返す。
1MB を超えるメモリ空間を使用するには、ソフトウェアが明示的に A20ゲートを有効化する必要がある。

# 初期化

本 OSでは、A20ゲートの制御に 8042 キーボードコントローラを利用している。

8042 には内部に8bitの出力ポート(チップ内部の レジスタ)が存在し、このうち bit1が A20ラインの制御に使用されている。
この bitを1にすることで、1MBを超えるメモリアドレスが使用可能となる。

この出力ポートはキーボード制御専用ではなく、複数の用途に使われている。

`outb(0x64, 0xD0)` は、8042 のコマンドポート（0x64）に「出力ポートの内容を送れ」というコマンドを送信する処理である。
このコマンドに対する応答として、出力ポートの内容がデータポート（0x60）に出力されるため、`inb(0x60)` によって現在の設定値を読み取ることができる。

※設定中にキーボードが押されても良いように先に無効化し、設定後に再度有効化する。
