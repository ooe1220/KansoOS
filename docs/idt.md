# IDTとは

IDT（Interrupt Descriptor Table）は、CPU に割り込みが発生した際に「どの関数（ハンドラ）を実行するか」を決定するための表である。

# PICとの関係

PIC は割り込み番号を CPUに通知するが、
その番号を受け取った CPU は、IDTを参照して対応する割り込みハンドラを呼び出す。
PIC は「番号を出す」役割、IDT は「番号に対応する処理を決める」役割を持つ。

# IDTの構造

IDT表は最大 256 個の要素を持ち、それぞれの要素には以下の情報が含まれている。

- 実行する割り込み関数(ハンドラ)のアドレス
- 使用するコードセグメント(GDT解説参照)
- 割り込みゲートの種類
- 呼び出し可能な特権レベル

# OS中で実装している構造体

上記の情報を OS 内で扱うために、簡素OSでは以下のような構造体を定義している。
```c
struct idt_entry {
    uint16_t offset_low;
    uint16_t selector;
    uint8_t  zero;
    uint8_t  type_attr;
    uint16_t offset_high;
} __attribute__((packed));
```
この構造体がIDT表の1要素に相当し、割り込み番号毎に1つずつ用意される。

## offset_low / offset_high

割り込みハンドラのアドレスは 32bit だが、IDT形式では16bitずつに分割して保存されている。
- offset_low : アドレスの下位 16bit
- offset_high : アドレスの上位 16bit
`offset_high << 16 | offset_low`の様に計算することで32ビットのアドレスが復元出来る。
つまりoffset_low と offset_high は1つのアドレスを上下に分けて保存しているだけ


## selector

selector には、割り込みハンドラを実行するためのコードセグメントを指定する。
詳しくはGDTの解説を参照。

## type_attr

type_attr には、以下のような情報がまとめて入っている。
- この割り込みが有効かどうか
- 割り込みゲートの種類
- 呼び出し可能な特権レベル

簡素OSでは`0x8E`を設定している。
`0x8E = 1000 1110b`
| ビット    | 意味   | 説明                |
| ------ | ---- | ----------------- |
| bit7   | P    | 1 = 有効（この割り込みを使う） |
| bit6-5 | DPL  | 00 = カーネル専用       |
| bit3-0 | Type | 1110 = 割り込みゲート    |
割り込みゲートでは、ハンドラ実行中に CPU が自動的に割り込みを禁止する。
トラップゲートでは割り込み禁止が行われないため、通常の割り込み処理には向かない。

## zero

この位置には`0`を置くという決まり。毎回必ず`0`を設定する。





