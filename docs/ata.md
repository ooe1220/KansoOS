
# 待機処理
 
## 状態レジスタ

ポート`0x1F7`はATAの状態レジスタに対応している。

| bit | 値    | 名前      | 意味         |
| --- | ---- | ------- | ---------- |
| 7   | 0x80 | BSY     | 処理中        |
| 3   | 0x08 | DRQ | データ要求（転送可） |
| 0   | 0x01 | ERR | エラー発生      |


## 処理が終わるのを待つ

処理中（BSY=1）の間は、コマンドやデータを受け付けない為、bit7(BSY)が1の間、待ち続ける。
```
while (inb(0x1F7) & 0x80);
```

`0x80`=`1000 0000`bなので
```
    1XXX XXXX
AND 1000 0000
--------------
    1000 0000
```

## 転送可能になるまで待つ


```
static int ata_wait_drq(void) {
    uint8_t s;
    while (1) {
        s = inb(0x1F7);
        if (s & 0x01) return -1; // ERR
        if (s & 0x08) return 0;  // DRQ
    }
}
```
