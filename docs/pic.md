
# PICの初期化に関して

本章では Intel 8259A（PIC）の初期化について説明する。
簡素OSの初期化コードは以下の通り。

```c
void pic_init(void) {
    outb(0x20, 0x11);
    outb(0xA0, 0x11);
    outb(0x21, 0x20);
    outb(0xA1, 0x28);
    outb(0x21, 0x04);
    outb(0xA1, 0x02);
    outb(0x21, 0x01);
    outb(0xA1, 0x01);

    // 初期状態は全IRQ禁止
    outb(0x21, 0xFF);
    outb(0xA1, 0xFF);
}
```

x86系パソコン向けOS自作において、この設定値は実質固定値となっているが、
それぞれの値には意味がある。

# 初期化の流れ

## ICWとは
ICW（Initialization Command Word）とは、
8259 PIC を初期化するために送る制御データである。

PIC は ICW1〜ICW4 を順番に受け取ることで、
割り込み番号の割り当てや動作モードを決定する。


## 設定用ポート
| PIC     | コマンドポート | データポート |
| ------- | ------- | ------ |
| マスターPIC | `0x20`  | `0x21` |
| スレーブPIC | `0xA0`  | `0xA1` |

- コマンドポート
ICW1
OCW2 / OCW3

- データポート
ICW2〜ICW4
割り込みマスク (IMR)

## ICW1 — 初期化開始と基本動作の指定

```c
    outb(0x20, 0x11);
    outb(0xA0, 0x11);
```

ICW1 の主なビット
| ビット  | 名前   | 値 | 意味         |
| ---- | ---- | - | ---------- |
| bit4 | INIT | 1 | これから PIC の初期設定を行うことを通知する |
| bit3 | LTIM | 0 | エッジトリガ     |
| bit2 | ADI  | 0 | 8086では未使用  |
| bit1 | SNGL | 0 | PICを2つ接続して使用    |
| bit0 | IC4  | 1 | ICW4 を使用   |

以上から設定値は以下のようになる
```
bit7 bit6 bit5 bit4 bit3 bit2 bit1 bit0
  0    0    0    1    0    0    0    1
```
`00010001b`は16進数で`0x11`となる。

## ICW2 — IRQ を CPU のどの割り込み番号に割り当てるか

ICW2 では、IRQ を CPU の割り込みベクタ番号にどのように対応付けるかを指定する。

```
    outb(0x21, 0x20);
    outb(0xA1, 0x28);
```

0x20 は 割り込みベクタ番号の基準値を表す。
IRQ0 → 割り込み番号 0x20
IRQ1 → 0x21
…
IRQ7 → 0x27
つまり、「IRQ番号 + 0x20」 が CPU に渡される割り込み番号になる。

0x28 は スレーブPIC側の基準値。
IRQ8 → 0x28
IRQ9 → 0x29
…
IRQ15 → 0x2F
0x28 = 0x20 + 8 となっており、マスターPICの IRQ0〜7 の直後に配置されている。

CPU 例外は `0x00〜0x1F` を使用するため、IRQは `0x20`以降に配置する。
※ 割り込み番号については、以下の記事で触れている。
https://qiita.com/earthen94/items/f5afe5d83462f54b7907


## ICW3 — マスターとスレーブの接続関係

```c
    outb(0x21, 0x04);
    outb(0xA1, 0x02);
```

`0x04` = `0000 0100b`
マスター PIC の IRQ2 にスレーブ PIC が接続されていることを表す。

`0x02` = `0000 0010b`
スレーブ PIC は、マスター PIC の IRQ2 に接続されていることを表す。

- マスター PIC 側
スレーブが接続されている IRQ 番号を ビットマスクで表現する
（IRQ2 → bit2 を 1）

- スレーブ PIC 側
自身が接続されている IRQ 番号を 数値として表現する
（IRQ2 → 2）

一見すると表現方法が異なり不自然に見えるが、
これは 8259 PIC の仕様である。

ICW3は配線を設定するものではなく、既に決まっている配線状況を PIC に伝えるための設定である。
x86 系のパソコンではこの接続方法は固定されており、ソフトウェアから変更することはできない。

## ICW4 — モード指定

```
    outb(0x21, 0x01);
    outb(0xA1, 0x01);
```

bit0を`1`にすることで、PIC は 8086 / 88 互換モードで動作する。  
他のビットにも機能は存在するが、x86系パソコンでは使用しないため、本 OSでは全て`0`としている。


