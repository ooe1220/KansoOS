#include "x86/io.h"

static const uint8_t mode13_regs[] = {
    /* MISC */
    0x63,
    /* SEQ */
    0x03, 0x01, 0x0f, 0x00, 0x0e,
    /* CRTC */
    0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0xbf, 0x1f,
    0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    //0x9c, 0x8e, 0x8f, 0x28, 0x40, 0x96, 0xb9, 0xa3,
    0x9c, 0x0e, 0x8f, 0x28, 0x40, 0x96, 0xb9, 0xa3,
    0xff,
    /* GRDC */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0f, 0xff,
    /* ACTL */
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
    0x41, 0x00, 0x0f, 0x00
};

void set_mode13(void) {
    const uint8_t *regs = mode13_regs;
    int i;
    
    /* MISC */
    outb(0x3C2, *regs++);

    /* SEQ */
    for (i = 0; i < 5; i++) {
        outb(0x3C4, i);
        outb(0x3C5, *regs++);
    }

    /* CRTC unlock */
    outb(0x3D4, 0x11);
    outb(0x3D5, inb(0x3D5) & ~0x80);

    /* CRTC */
    for (i = 0; i < 25; i++) {
        outb(0x3D4, i);
        outb(0x3D5, *regs++);
    }

    /* Graphics Controller */
    for (i = 0; i < 9; i++) {
        outb(0x3CE, i);
        outb(0x3CF, *regs++);
    }

    /* Attribute Controller */
    inb(0x3DA); // 初期化
    for (i = 0; i < 21; i++) {
        outb(0x3C0, i);
        outb(0x3C0, *regs++);
    }

       
    outb(0x3C8, 0);   // palette index 0
    for (int i = 0; i < 256; i++) {
        outb(0x3C9, i >> 2); // R
        outb(0x3C9, i >> 2); // G
        outb(0x3C9, i >> 2); // B
    }
    //outb(0x3C6, 0xFF);////////////
    inb(0x3DA);        // Reset Flip-Flop again
    outb(0x3C0, 0x20);   // display enable
}

